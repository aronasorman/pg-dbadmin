---
- hosts: original-db
  tasks:
    - name: move the new configuration file into the data folder
      copy: 
        src: config/postgresql.conf
        dest: /etc/postgresql/9.6/main/
        mode: 0600

    - name: move the new pg_hba file into the data folder
      copy: 
        src: config/pg/pg_hba.conf
        dest: /etc/postgresql/9.6/main/
        mode: 0600

    - name: create repmgr.conf
      copy:
        src: config/pg/repmgr.conf
        dest: /etc/

    - name: add client authentication
      lineinfile:
        dest: /etc/postgresql/9.6/main/pg_hba.conf
        line: 'host replication postgres    192.168.33.9/32   trust'

    - name: add client authentication (second)
      lineinfile:
        dest: /etc/postgresql/9.6/main/pg_hba.conf
        line: 'host all postgres    192.168.33.9/32   trust'
 
    - name: change the hostname
      command: hostname pg

    - block: 
      - name: generate ssh keys
        expect: 
          command: ssh-keygen -t rsa
          responses:
            'Enter file in which to save the key \(/var/lib/postgresql/.ssh/id_rsa\):': "\n"
            'Enter passphrase \(empty for no passphrase\):': "\n"
            'Enter same passphrase again:': "\n"
            
      - name: config ssh
        file: 
          path: /var/lib/postgresql/.ssh/config
          state: touch

      - name: add to config
        lineinfile:
          dest: /var/lib/postgresql/.ssh/config
          line: 'Host 192.168.33.9'

      - name: add another line
        lineinfile:
          dest: /var/lib/postgresql/.ssh/config
          line: 'StrictHostKeyChecking no'

      - name: create user
        command: createuser -s repmgr

      - name: create databse
        command: createdb repmgr -O repmgr
      become: true
      become_method: sudo
      become_user: postgres

    - name: fetch the public key to store in the local box
      fetch:
        src: /var/lib/postgresql/.ssh/id_rsa.pub
        dest: tmp

    - name: restart server
      service:
        name: postgresql
        state: restarted

    - name: reload configuration files
      service:
        name: postgresql
        state: reloaded

    - name: register as master
      command: repmgr -f /etc/repmgr.conf master register
      become: true
      become_user: postgres
      become_method: sudo

- hosts: standby
  tasks: 
    - name: change host name
      command: hostname standby

    - name: install barman-cli
      apt: 
        name: barman-cli

    - name: move the new configuration file into the data folder
      copy: 
        src: config/postgresql.conf
        dest: /etc/postgresql/9.6/main/
        mode: 0600
    
    - name: move the new pg_hba file into the data folder
      copy: 
        src: config/standby/pg_hba.conf
        dest: /etc/postgresql/9.6/main/
        mode: 0600

    - name: create repmgr.conf
      copy:
        src: config/standby/repmgr.conf
        dest: /etc/

    - block: 
      - name: generate ssh keys
        expect: 
          command: ssh-keygen -t rsa
          responses:
            'Enter file in which to save the key \(/var/lib/postgresql/.ssh/id_rsa\):': "\n"
            'Enter passphrase \(empty for no passphrase\):': "\n"
            'Enter same passphrase again:': "\n"
            
      - name: config ssh
        file: 
          path: /var/lib/postgresql/.ssh/config
          state: touch

      - name: add barman server ip address to config
        lineinfile:
          dest: /var/lib/postgresql/.ssh/config
          line: 'Host 192.168.33.9'
      
      - name: add user to config
        lineinfile:
          dest: /var/lib/postgresql/.ssh/config
          line: 'User barman'

      - name: add another line
        lineinfile:
          dest: /var/lib/postgresql/.ssh/config
          line: 'StrictHostKeyChecking no'

      - name: copy barman public key into authorized_keys
        copy:
          src: tmp/machine1/var/lib/barman/.ssh/id_rsa.pub
          dest: /var/lib/postgresql/.ssh/authorized_keys
          mode: 0600
      become: true
      become_method: sudo
      become_user: postgres

    - name: fetch the public key to store in the local box
      fetch:
        src: /var/lib/postgresql/.ssh/id_rsa.pub
        dest: tmp

    - name: stop server
      service:
        name: postgresql
        state: stopped

    - name: remove postgresql folder
      file:
        path: /var/lib/postgresql/9.6/main/
        state: absent

    - name: clone standby
      command: repmgr -h 192.168.33.10 -d repmgr -D /var/lib/postgresql/9.6/main -f /etc/repmgr.conf standby clone
      become: true
      become_user: postgres
      become_method: sudo

    - name: start server
      service:
        name: postgresql
        state: started

    - name: reload configuration files
      service:
        name: postgresql
        state: reloaded

    - name: register as standby
      command: repmgr -f /etc/repmgr.conf standby register
      become: true
      become_user: postgres
      become_method: sudo
